name: üöÄ Deploy ECOTACHOS a DigitalOcean

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

jobs:
  # ============================================
  # 1. TESTS Y VALIDACI√ìN
  # ============================================
  test:
    runs-on: ubuntu-latest
    name: üß™ Tests & Validation
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v3

      - name: üêç Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: üîç Lint Backend
        continue-on-error: true
        run: |
          cd ecotachostec-backend3/src
          pip install --upgrade pip
          pip install -r requirements.txt
          python -m py_compile core/*.py

      - name: üß™ Tests Backend
        continue-on-error: true
        run: |
          cd ecotachostec-backend3/src
          python manage.py test --settings=ecotachostec_backend.settings 2>&1 | head -50 || true

      - name: üì¶ Validar requirements.txt
        run: |
          cd ecotachostec-backend3/src
          pip install -r requirements.txt 2>&1 | tail -20

  # ============================================
  # 2. BUILD IM√ÅGENES DOCKER
  # ============================================
  build:
    runs-on: ubuntu-latest
    needs: test
    name: üê≥ Build Docker Images
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v3

      - name: üê≥ Configurar Docker
        uses: docker/setup-buildx-action@v2

      - name: üèóÔ∏è Build Backend
        run: |
          cd ecotachostec-backend3
          docker build -f docker/Dockerfile -t backend:latest .
          docker images

      - name: üèóÔ∏è Build Frontend
        run: |
          cd ecotachostec-frontend2
          docker build -f Dockerfile -t frontend:latest .
          docker images

  # ============================================
  # 3. DESPLIEGUE EN DIGITALOCEAN
  # ============================================
  deploy:
    runs-on: ubuntu-latest
    needs: build
    name: üöÄ Deploy to Droplet
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: üìã Informaci√≥n del despliegue
        run: |
          echo "üîî Informaci√≥n del despliegue:"
          echo "   Branch: ${{ github.ref }}"
          echo "   Commit: ${{ github.sha }}"
          echo "   Autor: ${{ github.actor }}"
          echo "   Mensaje: ${{ github.event.head_commit.message }}"

      - name: üîë Configurar SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DROPLET_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: üì¶ Subir c√≥digo al Droplet
        run: |
          rsync -avz -e "ssh -i ~/.ssh/deploy_key -o ConnectTimeout=5" \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '__pycache__' \
            --exclude '.env' \
            --exclude 'venv' \
            ./ root@${{ secrets.DROPLET_IP }}:/root/ecotachos/ \
            2>&1 | tail -20

      - name: üöÄ Ejecutar despliegue en Droplet
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.DROPLET_IP }} << 'DEPLOY'
          set -e
          echo "üìç Iniciando despliegue en Droplet..."
          cd /root/ecotachos
          
          # Git
          echo "üì• Actualizando repositorio..."
          git pull origin main 2>/dev/null || true
          
          # Docker
          echo "üê≥ Deteniendo servicios..."
          docker-compose down 2>/dev/null || true
          
          echo "üèóÔ∏è Construyendo im√°genes..."
          docker-compose build --no-cache 2>&1 | tail -5
          
          echo "üöÄ Iniciando servicios..."
          docker-compose up -d
          
          echo "‚è≥ Esperando servicios (30s)..."
          sleep 30
          
          # Migraciones
          echo "üîÑ Ejecutando migraciones..."
          docker-compose exec -T backend python manage.py migrate --noinput 2>&1 | tail -5 || true
          docker-compose exec -T backend python manage.py collectstatic --noinput 2>&1 | tail -3 || true
          
          echo "‚úÖ Despliegue completado en servidor"
          DEPLOY

      - name: üè• Health Checks
        run: |
          echo "üîç Verificando servicios..."
          
          for i in {1..10}; do
            if curl -f http://${{ secrets.DROPLET_IP }}:8000/health/ > /dev/null 2>&1; then
              echo "‚úÖ Backend OK"
              break
            fi
            echo "‚è≥ Esperando Backend ($i/10)..."
            sleep 3
          done
          
          for i in {1..10}; do
            if curl -f http://${{ secrets.DROPLET_IP }}:80/health > /dev/null 2>&1; then
              echo "‚úÖ Frontend OK"
              break
            fi
            echo "‚è≥ Esperando Frontend ($i/10)..."
            sleep 3
          done
          
          echo "‚úÖ Todos los servicios est√°n OK"

      - name: üìä Mostrar estado de servicios
        if: always()
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.DROPLET_IP }} << 'STATUS'
          echo "üìä Estado de servicios:"
          cd /root/ecotachos
          docker-compose ps
          echo ""
          echo "üìã √öltimos logs (√∫ltimas 10 l√≠neas):"
          docker-compose logs --tail=10
          STATUS

      - name: ‚úÖ Despliegue exitoso
        if: success()
        run: |
          echo "üéâ Despliegue completado exitosamente!"
          echo ""
          echo "üìå Acceso a servicios:"
          echo "   Frontend:  http://${{ secrets.DROPLET_IP }}"
          echo "   Backend:   http://${{ secrets.DROPLET_IP }}:8000"
          echo "   IP:        ${{ secrets.DROPLET_IP }}"

  # ============================================
  # 4. ROLLBACK AUTOM√ÅTICO (si falla)
  # ============================================
  rollback:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure() && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    name: üîô Rollback

    steps:
      - name: üîë Configurar SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DROPLET_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DROPLET_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: üîô Ejecutar rollback
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.DROPLET_IP }} << 'ROLLBACK'
          echo "‚ö†Ô∏è  ROLLBACK en progreso..."
          cd /root/ecotachos
          
          docker-compose down
          git revert HEAD --no-edit 2>/dev/null || git reset --hard HEAD~1
          docker-compose up -d
          
          sleep 10
          docker-compose ps
          
          echo "‚úÖ Rollback completado - Sistema restaurado"
          ROLLBACK

  # ============================================
  # 5. NOTIFICACIONES
  # ============================================
  notify:
    runs-on: ubuntu-latest
    needs: [test, build, deploy]
    if: always()
    name: üìß Notifications

    steps:
      - name: üìß Notificaci√≥n por correo
        if: always()
        run: |
          STATUS="‚ùå FALL√ì"
          if [ "${{ job.status }}" == "success" ]; then
            STATUS="‚úÖ EXITOSO"
          fi
          
          echo "Pipeline $STATUS"
          echo "Rama: ${{ github.ref }}"
          echo "Autor: ${{ github.actor }}"
